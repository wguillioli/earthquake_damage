---
title: "earthquake_damage"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

rm(list = ls())

require(tidyverse)
require(Amelia)

github_folder <- "C:/GitHub/earthquake_damage/"
setwd(github_folder) #no sirve
#root.dir?

```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

```{r}

#load data

test_values <- read.csv(paste0(github_folder,"data/test_values.csv"))
train_labels <- read.csv(paste0(github_folder,"data/train_labels.csv"))
train_values <- read.csv(paste0(github_folder,"data/train_values.csv"))

train <- inner_join(train_values, train_labels, by = "building_id")

test_values$damage_grade <- NA
test_values$data_group <- "test"
train$data_group <- "train"

d <- rbind(train,test_values)

summary(d)

glimpse(d)

#missmap(d)

#rm(list = c("train", "test_values", "train_labels", "train_values"))

#na by col
sum(is.na(d[,-40])) #col 40 is damage_grade from test so ignore

```
```{r}
#target var
d %>%
  filter(data_group == "train") %>%
  group_by(damage_grade) %>%
  tally() %>%
  mutate(prop = n/sum(n)) #57% 2, 33% 3, %10 1
```
```{r}

# --------------------------------------------------
# Manually see which vars have potential to predict, quickie

#number
numeric_vars <- c("geo_level_1_id",
                  "geo_level_2_id",
                  "geo_level_3_id",
                  "age",
                  "area_percentage",
                  "height_percentage")             

#discrete
discrete_vars <- c("count_floors_pre_eq",
                   "land_surface_condition",
                   "foundation_type",
                   "roof_type",
                   "ground_floor_type",
                   "other_floor_type",
                   "position",
                   "plan_configuration",
                   "has_superstructure_adobe_mud",
                   "has_superstructure_mud_mortar_stone",
                   "has_superstructure_stone_flag",
                   "has_superstructure_cement_mortar_stone",
                   "has_superstructure_mud_mortar_brick",
                   "has_superstructure_cement_mortar_brick",
                   "has_superstructure_timber",
                   "has_superstructure_bamboo",
                   "has_superstructure_rc_non_engineered",
                   "has_superstructure_rc_engineered",
                   "has_superstructure_other",
                   "legal_ownership_status",
                   "count_families",
                   "has_secondary_use",
                   "has_secondary_use_agriculture",
                   "has_secondary_use_hotel",
                   "has_secondary_use_rental",
                   "has_secondary_use_institution",
                   "has_secondary_use_school",
                   "has_secondary_use_industry",
                   "has_secondary_use_health_post",
                   "has_secondary_use_gov_office",
                   "has_secondary_use_use_police",
                   "has_secondary_use_other")


#na
#"building_id"
#"damage_grade"                          
#"data_group"  

dim(train[,c(discrete_vars,"damage_grade")])
train_discrete_eda <- train[,c(discrete_vars,"damage_grade")]

for (i in 1:ncol(train_discrete_eda)){
  print(paste0(i, " --- ", names(train_discrete_eda[i])))
  t <- table(train_discrete_eda$damage_grade, train_discrete_eda[,i])
  p <- round(prop.table(t, margin = 2), 2)
  print(t)
  print(p)
}

dim(train[,c(numeric_vars,"damage_grade")])
train_numeric_eda <- train[,c(numeric_vars,"damage_grade")]

for (i in 1:ncol(train_numeric_eda)){
  print(paste0(i, " --- ", names(train_numeric_eda[i])))
  boxplot(train_numeric_eda[,i] ~ damage_grade , train_numeric_eda, 
          horizontal = TRUE, xlab = names(train_numeric_eda[i]))
  #print(quantile)
  #t <- table(train_discrete_eda$damage_grade, train_discrete_eda[,i])
  #p <- round(prop.table(t, margin = 2), 2)
  #print(t)
  #print(p)
}

ggplot(train_numeric_eda, aes(age, damage_grade)) +
  geom_boxplot()

boxplot(train_numeric_eda[,1] ~ damage_grade , train_numeric_eda, 
        horizontal = TRUE)

#for (i in 5:(ncol(train))){
#  print(i)
#  x <- names(train[i])
#  print(x)
#  t <- table(train[,40], train[,i])
#  print(t)
#  p <- round(prop.table(t, margin = 2),2)
#  print(p)
#  barplot(p, xlab = x)
#}

#t <- table(train$damage_grade, train$count_floors_pre_eq)
#t <- table(train$damage_grade, train[,5])
#dim(train$damage_grade)
#dim(train[,40])
#dim(train[,5])

table(train[,40], train[,5])



print(t)
p <- round(prop.table(t, margin = 2), 2)
print(p)


```

```{r}
# [1] "1 --- count_floors_pre_eq"
# combine 6,7, 8, 9
d %>%
  mutate(count_floors_pre_eq_fct = as.character(count_floors_pre_eq)) %>%
  mutate(count_floors_pre_eq_fct = case_when(
    count_floors_pre_eq_fct %in% c("") ))
           
           
           as.factor(case_when(
    count_floors_pre_eq >= 6 ~ 6,
    TRUE ~ count_floors_pre_eq))) %>%
  group_by(count_floors_pre_eq_fct) %>%
  tally()





```


